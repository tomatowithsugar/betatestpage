<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불광서부회중 전시대 신청</title>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCUe4dXiwGiMsKtMCQfLVScx9iM4sEwF50",
            authDomain: "cart-witnessing-404c0.firebaseapp.com",
            projectId: "cart-witnessing-404c0",
            storageBucket: "cart-witnessing-404c0.firebasestorage.app",
            messagingSenderId: "616001042576",
            appId: "1:616001042576:web:314fe2268c8fffe82a8015",
            measurementId: "G-HT3T8YS1MW"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역에서 사용할 수 있도록 window 객체에 저장
        window.firebaseApp = app;
        window.db = db;
        window.firestoreFunctions = {
            collection,
            addDoc,
            getDocs,
            query,
            where,
            onSnapshot,
            deleteDoc,
            doc
        };

        // DOM이 로드된 후 실행
        window.addEventListener('DOMContentLoaded', function() {
            window.initializeApp();
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.3;
        }

        .login-page {
            display: block;
        }

        .main-page {
            display: none;
        }

        .login-form {
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 16px;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #6c757d;
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            padding: 8px 16px;
            width: auto;
            font-size: 14px;
            margin: 0;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .day-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .zone-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .day-option, .zone-option {
            position: relative;
        }

        .day-option input[type="radio"], .zone-option input[type="radio"] {
            display: none;
        }

        .day-label, .zone-label {
            display: block;
            padding: 15px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
        }

        .zone-label {
            padding: 20px 15px;
        }

        .day-option input[type="radio"]:checked + .day-label,
        .zone-option input[type="radio"]:checked + .zone-label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .day-label:hover, .zone-label:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .date-info {
            font-size: 11px;
            margin-top: 3px;
            color: #999;
            font-weight: normal;
        }

        .day-option input[type="radio"]:checked + .day-label .date-info {
            color: rgba(255, 255, 255, 0.8);
        }

        .capacity-info {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            color: #888;
        }

        .zone-label .capacity-info {
            font-size: 14px;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .applicants-list {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .applicants-list h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .day-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .day-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .zone-applicants {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .zone-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .applicant-names {
            color: #666;
            font-size: 14px;
        }

        .zone-selection-container {
            display: none;
        }

        .zone-selection-container.show {
            display: block;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .modal h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
        }

        /* 신청 취소 모달 스타일 */
        .cancel-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cancel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .cancel-info {
            flex: 1;
        }

        .cancel-day {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .cancel-details {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .no-applications {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로그인 페이지 -->
        <div class="login-page" id="loginPage">
            <h1>불광서부회중<br>전시대 봉사 신청</h1>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="loginName">이름</label>
                    <input type="text" id="loginName" placeholder="이름을 입력하세요" required>
                </div>
                <button type="button" class="btn" onclick="login()">확인</button>
            </div>
        </div>

        <!-- 메인 페이지 -->
        <div class="main-page" id="mainPage">
            <h1>불광서부회중<br>전시대 봉사 신청</h1>
            
            <div class="user-info" id="userInfo"></div>
            
            <div class="action-buttons">
                <button type="button" class="btn" onclick="openRegistrationModal()">전시대 봉사 신청</button>
                <button type="button" class="btn secondary" onclick="openCancelModal()">신청 취소</button>
                <button type="button" class="btn secondary" onclick="openMyApplicationsModal()">나의 신청 내역</button>
            </div>
        </div>

        <!-- 신청 현황은 두 페이지 모두에서 공통으로 표시 -->
        <div class="applicants-list">
            <h3>신청 현황</h3>
            <div id="applicantsList"></div>
        </div>

        <div id="message" class="message"></div>
    </div>

    <!-- 신청 모달 -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegistrationModal()">&times;</span>
            <h2>전시대 봉사 신청</h2>
            
            <form id="registrationForm">
                <div class="form-group">
                    <label>요일 선택</label>
                    <div class="day-selection">
                        <div class="day-option">
                            <input type="radio" id="monday" name="day" value="월요일">
                            <label for="monday" class="day-label" data-day="월요일">
                                월요일
                                <div class="date-info" id="monday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="tuesday" name="day" value="화요일">
                            <label for="tuesday" class="day-label" data-day="화요일">
                                화요일
                                <div class="date-info" id="tuesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="wednesday" name="day" value="수요일">
                            <label for="wednesday" class="day-label" data-day="수요일">
                                수요일
                                <div class="date-info" id="wednesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="thursday" name="day" value="목요일">
                            <label for="thursday" class="day-label" data-day="목요일">
                                목요일
                                <div class="date-info" id="thursday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="friday" name="day" value="금요일">
                            <label for="friday" class="day-label" data-day="금요일">
                                금요일
                                <div class="date-info" id="friday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="saturday" name="day" value="토요일">
                            <label for="saturday" class="day-label" data-day="토요일">
                                토요일
                                <div class="date-info" id="saturday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="sunday" name="day" value="일요일">
                            <label for="sunday" class="day-label" data-day="일요일">
                                일요일
                                <div class="date-info" id="sunday-date"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group zone-selection-container" id="zoneSelectionContainer">
                    <label>구역 선택</label>
                    <div class="zone-selection" id="zoneSelection">
                        <div class="zone-option">
                            <input type="radio" id="zone1" name="zone" value="1구역">
                            <label for="zone1" class="zone-label" data-zone="1구역">
                                1구역
                                <div class="capacity-info">0/4</div>
                            </label>
                        </div>
                        <div class="zone-option">
                            <input type="radio" id="zone2" name="zone" value="2구역">
                            <label for="zone2" class="zone-label" data-zone="2구역">
                                2구역
                                <div class="capacity-info">0/4</div>
                            </label>
                        </div>
                        <div class="zone-option">
                            <input type="radio" id="zone3" name="zone" value="3구역">
                            <label for="zone3" class="zone-label" data-zone="3구역">
                                3구역
                                <div class="capacity-info">0/4</div>
                            </label>
                        </div>
                        <div class="zone-option">
                            <input type="radio" id="zone4" name="zone" value="4구역">
                            <label for="zone4" class="zone-label" data-zone="4구역">
                                4구역
                                <div class="capacity-info">0/4</div>
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">신청하기</button>
            </form>
        </div>
    </div>

    <!-- 신청 취소 모달 -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCancelModal()">&times;</span>
            <h2>신청 취소</h2>
            
            <div id="cancelList" class="cancel-list">
                <!-- 신청 내역이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 신청 내역 모달 -->
    <div id="myApplicationsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeMyApplicationsModal()">&times;</span>
        <h2>나의 이번 주 신청 내역</h2>
        <div id="myApplicationsList" class="cancel-list"></div>
    </div>
</div>

    <script>
        // 허용된 사용자 목록 (하드코딩)
        const allowedUsers = ['양진우', '테스트1', '테스트2', '테스트3', '테스트4', '테스트5'];
        
        // 신청자 데이터를 저장할 객체 (요일 > 구역 > 신청자 배열)
        const applicants = {};
        const days = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일', '일요일'];
        const zones = ['1구역', '2구역', '3구역', '4구역'];
        const maxCapacity = 4;
        let currentUser = '';
        let userApplications = []; // 현재 사용자의 신청 내역
        let allApplications = [];  // 전체 신청 문서 목록 ({id, name, day, zone, actualDate, ...})

        // 초기 데이터 구조 생성
        days.forEach(day => {
            applicants[day] = {};
            zones.forEach(zone => {
                applicants[day][zone] = [];
            });
        });

        // 페이지 로드 시 초기화
        window.initializeApp = function() {
            setCurrentWeekDates();
            loadDataFromFirestore();
            
            // Enter 키로 로그인
            document.getElementById('loginName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        };

        // Firestore에서 데이터 로드 (현재 주 데이터만)
        async function loadDataFromFirestore() {
            try {
                const { collection, onSnapshot, query, where } = window.firestoreFunctions;
                const applicantsRef = collection(window.db, 'applicants');
                
                // 현재 주의 날짜 범위 계산
                const currentWeekDates = getCurrentWeekDates();
                
                // 현재 주 데이터만 쿼리
                const weekQuery = query(
                    applicantsRef,
                    where('actualDate', '>=', currentWeekDates.start),
                    where('actualDate', '<=', currentWeekDates.end)
                );
                
                // 실시간 데이터 감지
                onSnapshot(weekQuery, (querySnapshot) => {
                    // 데이터 초기화
                    days.forEach(day => {
                        zones.forEach(zone => {
                            applicants[day][zone] = [];
                        });
                    });
                    
                    allApplications = [];
                    userApplications = []; // 사용자 신청 내역 초기화 (filter로 다시 채울 것)
                    
                    // Firestore에서 데이터 가져와서 로컬 객체에 저장
                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const { name, day, zone } = data;
                        
                        // applicants 구조에 이름 추가 (뷰용)
                        if (applicants[day] && applicants[day][zone]) {
                            applicants[day][zone].push(name);
                        }

                        // 전체 문서 목록에 id 포함해서 저장
                        allApplications.push({
                            id: docSnap.id,
                            ...data
                        });
                    });

                    // 현재 로그인된 사용자가 있으면 필터링해서 userApplications 갱신
                    filterUserApplications();

                    // 화면 갱신
                    updateDisplay();
                    
                    // 만약 취소 모달이 열려 있으면 취소 리스트 갱신
                    const cancelModal = document.getElementById('cancelModal');
                    if (cancelModal.style.display === 'block') {
                        updateCancelList();
                    }
                });
            } catch (error) {
                console.error('Firebase 연결 오류:', error);
                alert('데이터베이스 연결에 실패했습니다. Firebase 설정을 확인해주세요.');
            }
        }

        // 현재 주의 날짜 범위 계산 (월요일~일요일)
        function getCurrentWeekDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            const daysFromMonday = currentDay === 0 ? -6 : 1 - currentDay;
            monday.setDate(today.getDate() + daysFromMonday);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            return {
                start: monday.toISOString().split('T')[0], // YYYY-MM-DD
                end: sunday.toISOString().split('T')[0]    // YYYY-MM-DD
            };
        }

        // Firestore에 데이터 저장
        async function saveToFirestore(name, day, zone) {
            try {
                const { collection, addDoc } = window.firestoreFunctions;
                const applicantsRef = collection(window.db, 'applicants');
                
                const actualDate = getActualDateForDay(day);
                
                await addDoc(applicantsRef, {
                    name: name,
                    day: day,
                    zone: zone,
                    actualDate: actualDate, // 실제 날짜 (YYYY-MM-DD)
                    timestamp: new Date()   // 신청 시간
                });
                
                return true;
            } catch (error) {
                console.error('저장 오류:', error);
                alert('신청 저장 중 오류가 발생했습니다.');
                return false;
            }
        }

        // Firestore에서 데이터 삭제
        async function deleteFromFirestore(docId) {
            try {
                const { deleteDoc, doc } = window.firestoreFunctions;
                await deleteDoc(doc(window.db, 'applicants', docId));
                return true;
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('신청 취소 중 오류가 발생했습니다.');
                return false;
            }
        }

        // 로그인 함수 (사용자 제한 기능 추가)
        function login() {
            const name = document.getElementById('loginName').value.trim();
            if (!name) {
                alert('이름을 입력해주세요.');
                return;
            }
            
            // 허용된 사용자 검사
            if (!allowedUsers.includes(name)) {
                alert('등록되지 않은 전도인입니다.');
                document.getElementById('loginName').value = ''; // 입력란 초기화
                return;
            }
            
            currentUser = name;
            document.getElementById('userInfo').textContent = `${currentUser}님 환영합니다!`;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';

            // 로그인 시점에 전체 목록에서 사용자 신청만 필터링해서 userApplications 갱신
            filterUserApplications();
            // 취소 모달을 열면 바로 확인 가능하도록(모달이 열려있을 때) 취소 리스트 갱신
            updateCancelList();
            // 화면도 갱신(사용자 관점에서 변경될 수 있는 부분)
            updateDisplay();
        }

        // 사용자 신청만 필터링해서 userApplications에 채우는 함수
        function filterUserApplications() {
            if (!currentUser) {
                userApplications = [];
                return;
            }
            userApplications = allApplications.filter(a => a.name === currentUser);
        }

        // 신청 모달 열기
        function openRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'block';
            setCurrentWeekDates();
            updateZoneDisplayForModal();
        }

        // 신청 모달 닫기
        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            document.getElementById('registrationForm').reset();
            document.getElementById('zoneSelectionContainer').classList.remove('show');
        }

        // 신청 취소 모달 열기
        function openCancelModal() {
            document.getElementById('cancelModal').style.display = 'block';
            // 로그인 여부와 관계없이 allApplications 기반으로 userApplications를 갱신
            filterUserApplications();
            updateCancelList();
        }
        function openMyApplicationsModal() {
        updateMyApplicationsList();
        document.getElementById('myApplicationsModal').style.display = 'block';
    }

    function closeMyApplicationsModal() {
        document.getElementById('myApplicationsModal').style.display = 'none';
    }

    function updateMyApplicationsList() {
        const listContainer = document.getElementById('myApplicationsList');
        listContainer.innerHTML = '';

        if (userApplications.length === 0) {
            listContainer.innerHTML = `<div class="no-applications">이번 주 신청 내역이 없습니다.</div>`;
            return;
        }

        userApplications.forEach(app => {
            const item = document.createElement('div');
            item.className = 'cancel-item';
            item.innerHTML = `
                <div class="cancel-day">${app.day}</div>
                <div>${app.zone} (${app.actualDate})</div>
            `;
            listContainer.appendChild(item);
        });
    }

        // 신청 취소 모달 닫기
        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
        }

        // 신청 취소 목록 업데이트
        function updateCancelList() {
            const cancelListEl = document.getElementById('cancelList');
            cancelListEl.innerHTML = '';

            if (userApplications.length === 0) {
                const noApplicationsDiv = document.createElement('div');
                noApplicationsDiv.className = 'no-applications';
                noApplicationsDiv.textContent = '신청 내역이 없습니다.';
                cancelListEl.appendChild(noApplicationsDiv);
                return;
            }

            userApplications.forEach(application => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cancel-item';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'cancel-info';

                const dayDiv = document.createElement('div');
                dayDiv.className = 'cancel-day';
                dayDiv.textContent = application.day;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'cancel-details';
                
                const date = new Date(application.actualDate);
                const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                detailsDiv.textContent = `${dateString} • ${application.zone}`;

                infoDiv.appendChild(dayDiv);
                infoDiv.appendChild(detailsDiv);

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn danger';
                cancelBtn.textContent = '취소';
                cancelBtn.onclick = () => confirmCancelApplication(application);

                itemDiv.appendChild(infoDiv);
                itemDiv.appendChild(cancelBtn);
                cancelListEl.appendChild(itemDiv);
            });
        }

        // 신청 취소 확인
        function confirmCancelApplication(application) {
            const date = new Date(application.actualDate);
            const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            
            const confirmMessage = `${application.day}(${dateString}) ${application.zone} 전시대 봉사 신청을 취소하시겠습니까?`;
            
            if (confirm(confirmMessage)) {
                cancelApplication(application.id, application);
            }
        }

        // 신청 취소 실행
        async function cancelApplication(docId, application) {
            const deleted = await deleteFromFirestore(docId);
            
            if (deleted) {
                const date = new Date(application.actualDate);
                const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                alert(`${application.day}(${dateString}) ${application.zone} 신청이 취소되었습니다.`);
                closeCancelModal();
            }
        }

        // 현재 주의 각 요일 날짜 설정
        function setCurrentWeekDates() {
            const today = new Date();
            const currentDay = today.getDay(); // 0: 일요일, 1: 월요일, ..., 6: 토요일
            
            // 이번 주 월요일 찾기
            const monday = new Date(today);
            const daysFromMonday = currentDay === 0 ? -6 : 1 - currentDay; // 일요일인 경우 -6, 그 외는 1-현재요일
            monday.setDate(today.getDate() + daysFromMonday);
            
            // 각 요일의 날짜 설정
            const dayElements = [
                { id: 'monday-date', offset: 0 },
                { id: 'tuesday-date', offset: 1 },
                { id: 'wednesday-date', offset: 2 },
                { id: 'thursday-date', offset: 3 },
                { id: 'friday-date', offset: 4 },
                { id: 'saturday-date', offset: 5 },
                { id: 'sunday-date', offset: 6 }
            ];
            
            dayElements.forEach(day => {
                const date = new Date(monday);
                date.setDate(monday.getDate() + day.offset);
                const dateString = `${date.getMonth() + 1}/${date.getDate()}`;
                const element = document.getElementById(day.id);
                if (element) {
                    element.textContent = dateString;
                }
            });
        }

        // 요일 선택 시 구역 선택 영역 표시
        document.querySelectorAll('input[name="day"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const zoneContainer = document.getElementById('zoneSelectionContainer');
                if (this.checked) {
                    zoneContainer.classList.add('show');
                    updateZoneDisplay(this.value);
                    // 구역 선택 초기화
                    document.querySelectorAll('input[name="zone"]').forEach(zoneRadio => {
                        zoneRadio.checked = false;
                    });
                }
            });
        });

        // 폼 제출 이벤트 처리
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedDay = document.querySelector('input[name="day"]:checked');
            const selectedZone = document.querySelector('input[name="zone"]:checked');
            
            if (!selectedDay) {
                alert('요일을 선택해주세요.');
                return;
            }

            if (!selectedZone) {
                alert('구역을 선택해주세요.');
                return;
            }
            
            const dayValue = selectedDay.value;
            const zoneValue = selectedZone.value;
            
            // 정원 체크
            if (applicants[dayValue][zoneValue].length >= maxCapacity) {
                alert(`${dayValue} ${zoneValue}은 마감되었습니다.`);
                return;
            }
            
            // 중복 신청 체크 (같은 요일 다른 구역 포함)
            let isDuplicate = false;
            zones.forEach(zone => {
                if (applicants[dayValue][zone].includes(currentUser)) {
                    isDuplicate = true;
                }
            });
            
            if (isDuplicate) {
                alert(`${dayValue}에 이미 신청하셨습니다.`);
                return;
            }
            
            // Firestore에 저장
            const saved = await saveToFirestore(currentUser, dayValue, zoneValue);
            
            if (saved) {
                // 성공 메시지 표시
                alert(`${dayValue} ${zoneValue} 신청이 완료되었습니다!`);
                
                // 모달 닫기
                closeRegistrationModal();
            }
        });

        // 특정 요일의 실제 날짜 계산
        function getActualDateForDay(dayName) {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            const daysFromMonday = currentDay === 0 ? -6 : 1 - currentDay;
            monday.setDate(today.getDate() + daysFromMonday);
            
            const dayMap = {
                '월요일': 0, '화요일': 1, '수요일': 2, '목요일': 3,
                '금요일': 4, '토요일': 5, '일요일': 6
            };
            
            const targetDate = new Date(monday);
            targetDate.setDate(monday.getDate() + dayMap[dayName]);
            
            return targetDate.toISOString().split('T')[0]; // YYYY-MM-DD 형태
        }

        // 화면 업데이트 함수
        function updateDisplay() {
            updateApplicantsList();
        }

        // 모달에서 구역 표시 업데이트
        function updateZoneDisplayForModal() {
            // 모달이 열릴 때 초기화
            document.querySelectorAll('.zone-label').forEach(label => {
                label.style.background = '';
                label.style.color = '';
                label.style.borderColor = '';
                label.style.cursor = 'pointer';
                label.previousElementSibling.disabled = false;
            });
        }

        // 특정 요일의 구역 표시 업데이트
        function updateZoneDisplay(selectedDay) {
            const zoneLabels = document.querySelectorAll('.zone-label');
            
            zoneLabels.forEach(label => {
                const zone = label.dataset.zone;
                const currentCount = applicants[selectedDay][zone].length;
                const capacityInfo = label.querySelector('.capacity-info');
                const radioInput = label.previousElementSibling;
                
                capacityInfo.textContent = `${currentCount}/${maxCapacity}`;
                
                if (currentCount >= maxCapacity) {
                    label.style.background = '#ff6b6b';
                    label.style.color = 'white';
                    label.style.borderColor = '#ff6b6b';
                    label.style.cursor = 'not-allowed';
                    radioInput.disabled = true;
                } else {
                    // 선택되지 않은 상태로 초기화
                    if (!radioInput.checked) {
                        label.style.background = '';
                        label.style.color = '';
                        label.style.borderColor = '';
                    }
                    label.style.cursor = 'pointer';
                    radioInput.disabled = false;
                }
            });
        }

        // 신청자 목록 업데이트
        function updateApplicantsList() {
            const applicantsListEl = document.getElementById('applicantsList');
            applicantsListEl.innerHTML = '';
            
            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-section';
                
                const dayTitleDiv = document.createElement('div');
                dayTitleDiv.className = 'day-title';
                
                // 해당 요일의 날짜 가져오기
                const dayDate = getDateForDay(day);
                dayTitleDiv.textContent = `${day} (${dayDate})`;
                dayDiv.appendChild(dayTitleDiv);
                
                zones.forEach(zone => {
                    const zoneApplicants = applicants[day][zone];
                    
                    const zoneDiv = document.createElement('div');
                    zoneDiv.className = 'zone-applicants';
                    
                    const zoneNameDiv = document.createElement('div');
                    zoneNameDiv.className = 'zone-name';
                    zoneNameDiv.textContent = `${zone} (${zoneApplicants.length}/${maxCapacity})`;
                    
                    const applicantNamesDiv = document.createElement('div');
                    applicantNamesDiv.className = 'applicant-names';
                    applicantNamesDiv.textContent = zoneApplicants.length > 0 ? 
                        zoneApplicants.join(', ') : '신청자 없음';
                    
                    zoneDiv.appendChild(zoneNameDiv);
                    zoneDiv.appendChild(applicantNamesDiv);
                    dayDiv.appendChild(zoneDiv);
                });
                
                applicantsListEl.appendChild(dayDiv);
            });
        }

        // 특정 요일의 날짜 가져오기 (2025/8/4 형식)
        function getDateForDay(dayName) {
            const today = new Date();
            const currentDay = today.getDay();
            const monday = new Date(today);
            const daysFromMonday = currentDay === 0 ? -6 : 1 - currentDay;
            monday.setDate(today.getDate() + daysFromMonday);
            
            const dayMap = {
                '월요일': 0, '화요일': 1, '수요일': 2, '목요일': 3,
                '금요일': 4, '토요일': 5, '일요일': 6
            };
            
            const targetDate = new Date(monday);
            targetDate.setDate(monday.getDate() + dayMap[dayName]);
            
            return `${targetDate.getFullYear()}/${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
        }

        // 마감된 구역 클릭 방지
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('zone-label') && e.target.previousElementSibling.disabled) {
                e.preventDefault();
                const selectedDay = document.querySelector('input[name="day"]:checked');
                if (selectedDay) {
                    alert(`${selectedDay.value} ${e.target.dataset.zone}은 마감되었습니다.`);
                }
            }
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const registrationModal = document.getElementById('registrationModal');
            const cancelModal = document.getElementById('cancelModal');
            
            if (event.target == registrationModal) {
                closeRegistrationModal();
            }
            if (event.target == cancelModal) {
                closeCancelModal();
            }
        }
    </script>
</body>
</html>
