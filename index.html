<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불광서부회중 전시대 신청</title>
    <link rel="apple-touch-icon" href="apple-touch-icon_v3.png">
    <link rel="icon" type="image/png" href="favicon-512x512_v3.png">

    <!-- Firebase SDK -->
    <script type="module">import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCUe4dXiwGiMsKtMCQfLVScx9iM4sEwF50",
            authDomain: "cart-witnessing-404c0.firebaseapp.com",
            projectId: "cart-witnessing-404c0",
            storageBucket: "cart-witnessing-404c0.firebasestorage.app",
            messagingSenderId: "616001042576",
            appId: "1:616001042576:web:314fe2268c8fffe82a8015",
            measurementId: "G-HT3T8YS1MW"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 전역에서 사용할 수 있도록 window 객체에 저장
        window.firebaseApp = app;
        window.db = db;
        window.firestoreFunctions = {
            collection,
            addDoc,
            getDocs,
            query,
            where,
            onSnapshot,
            deleteDoc,
            doc
        };

        // DOM이 로드된 후 실행
        window.addEventListener('DOMContentLoaded', function () {
            window.initializeApp();
        });</script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.3;
        }

        .login-page {
            display: block;
        }

        .main-page, .admin-page {
            display: none;
        }

        .login-form {
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 16px;
        }

        input[type="text"], select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

            input[type="text"]:focus, select:focus {
                outline: none;
                border-color: #667eea;
            }

        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-bottom: 10px;
        }

            .btn:hover {
                transform: translateY(-2px);
            }

            .btn.secondary {
                background: #6c757d;
                background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            }

            .btn.danger {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                padding: 8px 16px;
                width: auto;
                font-size: 14px;
                margin: 0;
            }

            .btn.success {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                padding: 12px 20px;
                width: auto;
                font-size: 16px;
                margin: 0 5px;
            }

            .btn.admin {
                background: linear-gradient(135deg, #fd7e14 0%, #e63946 100%);
            }

            .btn.small {
                padding: 12px 20px;
                font-size: 16px;
                width: auto;
            }

            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

        .user-info {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
        }

        .admin-info {
            text-align: center;
            margin-bottom: 30px;
            color: #fd7e14;
            font-size: 18px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .day-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .zone-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .day-option, .zone-option {
            position: relative;
        }

            .day-option input[type="radio"], .zone-option input[type="radio"] {
                display: none;
            }

        .day-label, .zone-label {
            display: block;
            padding: 15px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
        }

        .zone-label {
            padding: 20px 15px;
        }

        .day-option input[type="radio"]:checked + .day-label,
        .zone-option input[type="radio"]:checked + .zone-label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .day-label:hover, .zone-label:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .date-info {
            font-size: 11px;
            margin-top: 3px;
            color: #999;
            font-weight: normal;
        }

        .day-option input[type="radio"]:checked + .day-label .date-info {
            color: rgba(255, 255, 255, 0.8);
        }

        .capacity-info {
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
            color: #888;
        }

        .zone-label .capacity-info {
            font-size: 14px;
        }

        .applicants-list {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

            .applicants-list h3 {
                margin-bottom: 15px;
                color: #333;
            }

        .day-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .day-title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .zone-applicants {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .zone-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .applicant-names {
            color: #666;
            font-size: 14px;
        }

        .zone-selection-container {
            display: none;
        }

            .zone-selection-container.show {
                display: block;
            }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0; /* 패딩 제거 */
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden; /* 전체 모달의 오버플로우 숨김 */
            position: relative;
            display: flex;
            flex-direction: column;
        }

            .modal-content.large {
                max-width: 800px;
            }
        
        .modal-header {
            position: sticky;
            top: 0;
            background: white;
            padding: 20px 20px 10px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            z-index: 1001;
            border-radius: 20px 20px 0 0;
        }
        
        .modal-body {
            padding: 20px 40px 40px 40px;
            overflow-y: auto;
            flex: 1;
        }

        .close {
            position: static; /* sticky 제거 */
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

            .close:hover {
                color: #000;
                background-color: #f5f5f5;
            }

        .modal h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 700;
        }

        /* 신청 취소 모달 스타일 */
        .cancel-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cancel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .cancel-info {
            flex: 1;
        }

        .cancel-day {
            font-weight: 700;
            color: #667eea;
            font-size: 16px;
        }

        .cancel-details {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .no-applications {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }

        /* 관리자 모달 스타일 */
        .admin-form {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

            .form-row.full {
                grid-template-columns: 1fr;
            }

        .admin-action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* 데이터 통계 스타일 */
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-nav-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

            .month-nav-btn:hover {
                background: #5a6fd8;
            }

        .current-month {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            min-width: 120px;
            text-align: center;
        }

        .stats-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .zone-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .zone-stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .zone-stat-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .zone-stat-bar {
            background: #e9ecef;
            border-radius: 5px;
            height: 8px;
            margin-bottom: 5px;
        }

        .zone-stat-fill {
            background: #667eea;
            border-radius: 5px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .zone-stat-text {
            font-size: 14px;
            color: #666;
        }

        /* 사용자 관리 스타일 */
        .user-list {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

            .user-list h3 {
                margin-bottom: 15px;
                color: #333;
            }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .user-name {
            font-weight: 600;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 로그인 페이지 -->
        <div class="login-page" id="loginPage">
            <h1>불광서부회중<br>전시대 봉사 신청</h1>

            <div class="login-form">
                <div class="form-group">
                    <label for="loginName">이름</label>
                    <input type="text" id="loginName" placeholder="이름을 입력하세요" required>
                </div>
                <button type="button" class="btn" onclick="login()">확인</button>
            </div>
        </div>

        <!-- 일반 사용자 메인 페이지 -->
        <div class="main-page" id="mainPage">
            <h1>불광서부회중<br>전시대 봉사 신청</h1>

            <div class="user-info" id="userInfo"></div>

            <div class="action-buttons">
                <button type="button" class="btn" onclick="openRegistrationModal()">전시대 봉사 신청</button>
                <button type="button" class="btn secondary" onclick="openCancelModal()">신청 취소</button>
            </div>
        </div>

        <!-- 관리자 페이지 -->
        <div class="admin-page" id="adminPage">
            <h1>관리자 모드</h1>

            <div class="admin-info">관리자님 환영합니다!</div>

            <div class="admin-actions">
                <button type="button" class="btn admin" onclick="openUserManagementModal()">사용자 관리</button>
                <button type="button" class="btn admin" onclick="openZoneManagementModal()">구역 관리</button>
                <button type="button" class="btn secondary" onclick="openStatsModal()">데이터 통계</button>
            </div>

        </div>

        <!-- 신청 현황 -->
        <div class="applicants-list">
            <h3>신청 현황</h3>
            <div id="applicantsList"></div>
        </div>
    </div>

    <!-- 신청 모달 -->
    <div id="registrationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeRegistrationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <h2>전시대 봉사 신청</h2>
                <form id="registrationForm">
            
            <span class="close" onclick="closeRegistrationModal()">&times;</span>
            <h2>전시대 봉사 신청</h2>

            <form id="registrationForm">
                <div class="form-group">
                    <label>요일 선택</label>
                    <div class="day-selection">
                        <div class="day-option">
                            <input type="radio" id="monday" name="day" value="월요일">
                            <label for="monday" class="day-label" data-day="월요일">
                                월요일
                                <div class="date-info" id="monday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="tuesday" name="day" value="화요일">
                            <label for="tuesday" class="day-label" data-day="화요일">
                                화요일
                                <div class="date-info" id="tuesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="wednesday" name="day" value="수요일">
                            <label for="wednesday" class="day-label" data-day="수요일">
                                수요일
                                <div class="date-info" id="wednesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="thursday" name="day" value="목요일">
                            <label for="thursday" class="day-label" data-day="목요일">
                                목요일
                                <div class="date-info" id="thursday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="friday" name="day" value="금요일">
                            <label for="friday" class="day-label" data-day="금요일">
                                금요일
                                <div class="date-info" id="friday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="saturday" name="day" value="토요일">
                            <label for="saturday" class="day-label" data-day="토요일">
                                토요일
                                <div class="date-info" id="saturday-date"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group zone-selection-container" id="zoneSelectionContainer">
                    <label>구역 선택</label>
                    <div class="zone-selection" id="zoneSelection">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>

                <button type="submit" class="btn">신청하기</button>
            </form>
        </div>
    </div>

    <!-- 신청 취소 모달 -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCancelModal()">&times;</span>
            <h2>신청 취소</h2>

            <div id="cancelList" class="cancel-list">
                <!-- 신청 내역이 여기에 표시됩니다 -->
            </div>
        </div>
    </div>

    <!-- 관리자 모달 -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAdminModal()">&times;</span>
            <h2>신청 관리</h2>

            <div class="admin-form">
                <div class="form-group">
                    <label for="adminUserSelect">사용자 선택</label>
                    <select id="adminUserSelect">
                        <option value="">사용자를 선택하세요</option>
                        <!-- 사용자 목록은 JS에서 동적으로 채워짐 -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="adminAction">작업</label>
                    <select id="adminAction">
                        <option value="">작업을 선택하세요</option>
                        <option value="assign">임의 배정</option>
                        <option value="cancel">임의 취소</option>
                    </select>
                </div>

                <div class="form-group" id="adminDayZoneRow" style="display: none;">
                    <label>요일 선택</label>
                    <div class="day-selection">
                        <div class="day-option">
                            <input type="radio" id="admin-monday" name="admin-day" value="월요일">
                            <label for="admin-monday" class="day-label" data-day="월요일">
                                월요일
                                <div class="date-info" id="admin-monday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="admin-tuesday" name="admin-day" value="화요일">
                            <label for="admin-tuesday" class="day-label" data-day="화요일">
                                화요일
                                <div class="date-info" id="admin-tuesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="admin-wednesday" name="admin-day" value="수요일">
                            <label for="admin-wednesday" class="day-label" data-day="수요일">
                                수요일
                                <div class="date-info" id="admin-wednesday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="admin-thursday" name="admin-day" value="목요일">
                            <label for="admin-thursday" class="day-label" data-day="목요일">
                                목요일
                                <div class="date-info" id="admin-thursday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="admin-friday" name="admin-day" value="금요일">
                            <label for="admin-friday" class="day-label" data-day="금요일">
                                금요일
                                <div class="date-info" id="admin-friday-date"></div>
                            </label>
                        </div>
                        <div class="day-option">
                            <input type="radio" id="admin-saturday" name="admin-day" value="토요일">
                            <label for="admin-saturday" class="day-label" data-day="토요일">
                                토요일
                                <div class="date-info" id="admin-saturday-date"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-group zone-selection-container" id="adminZoneSelectionContainer" style="display: none;">
                    <label>구역 선택</label>
                    <div class="zone-selection" id="adminZoneSelection">
                        <!-- 동적으로 생성됨 -->
                    </div>
                </div>

                <div id="adminCancelList" style="display: none;">
                    <h4>취소할 신청 선택</h4>
                    <div id="adminCancelOptions"></div>
                </div>

                <div class="admin-action-buttons">
                    <button type="button" class="btn success small" onclick="executeAdminAction()">실행</button>
                    <button type="button" class="btn secondary small" onclick="resetAdminForm()">초기화</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 관리 모달 -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeUserManagementModal()">&times;</span>
            <h2>사용자 관리</h2>

            <div class="form-group">
                <label for="newUserName">새 사용자 추가</label>
                <input type="text" id="newUserName" placeholder="이름을 입력하세요" required>
                <button type="button" class="btn success small" onclick="addNewUser()" style="margin-top: 10px;">추가</button>
            </div>

            <div class="user-list">
                <h3>등록된 사용자</h3>
                <div id="userManagementList"></div>
            </div>
        </div>
    </div>

    <!-- 구역 관리 모달 -->
    <div id="zoneManagementModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeZoneManagementModal()">&times;</span>
            <h2>구역 관리</h2>

            <div class="form-group">
                <label for="newZoneName">새 구역 추가</label>
                <input type="text" id="newZoneName" placeholder="구역 이름을 입력하세요" required>
            </div>
            <div class="form-group">
                <label for="newZoneCapacity">최대 용량</label>
                <input type="number" id="newZoneCapacity" placeholder="최대 용량 (기본 4)" value="4" min="1" required>
                <button type="button" class="btn success small" onclick="addNewZone()" style="margin-top: 10px;">추가</button>
            </div>

            <div class="user-list">
                <h3>등록된 구역</h3>
                <div id="zoneManagementList"></div>
            </div>
        </div>
    </div>

    <!-- 데이터 통계 모달 -->
    <div id="statsModal" class="modal">
        <div class="modal-content large">
            <span class="close" onclick="closeStatsModal()">&times;</span>
            <h2>데이터 통계</h2>

            <div class="stats-header">
                <div class="month-navigation">
                    <button class="month-nav-btn" onclick="changeMonth(-1)">‹</button>
                    <div class="current-month" id="currentMonth"></div>
                    <button class="month-nav-btn" onclick="changeMonth(1)">›</button>
                </div>
            </div>

            <div class="stats-content">
                <div class="stats-summary" id="statsSummary"></div>
                <div class="zone-stats" id="zoneStats"></div>
            </div>
        </div>
    </div>

    <script>// 신청자 데이터를 저장할 객체
        const applicants = {};
        const days = ['월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
        let zones = []; // 동적으로 로드
        let currentUser = '';
        let isAdmin = false;
        let userApplications = [];
        let allApplications = [];
        let currentStatsYear = new Date().getFullYear();
        let currentStatsMonth = new Date().getMonth() + 1;
        let allowedUsers = []; // 서버에서 로드될 배열
        let usersLoaded = false; // 사용자 데이터 로드 여부 확인 (추가)
        // 초기 데이터 구조 생성
        function initializeApplicants() {
            days.forEach(day => {
                applicants[day] = {};
                zones.forEach(zone => {
                    applicants[day][zone.name] = [];
                });
            });
        }

        // 페이지 로드 시 초기화
        window.initializeApp = function () {
            console.log('Initializing application...');
            setCurrentWeekDates();
            setAdminWeekDates();
            loadZonesFromFirestore(); // 구역 먼저 로드
            populateAdminUserSelect();
            loadDataFromFirestore();

            document.getElementById('loginName').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        };

        // Firestore에서 구역 목록 로드
        async function loadZonesFromFirestore() {
            try {
                const { collection, getDocs } = window.firestoreFunctions;
                const zonesRef = collection(window.db, 'zones');
                const querySnapshot = await getDocs(zonesRef);
                zones = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    zones.push({
                        id: doc.id,
                        name: data.name,
                        maxCapacity: data.maxCapacity || 4
                    });
                });
                console.log('Loaded zones from Firestore:', zones);
                initializeApplicants(); // zones 로드 후 applicants 초기화
                updateZoneUI(); // UI 업데이트
                updateDisplay(); // 신청 현황 업데이트
            } catch (error) {
                console.error('구역 로드 오류:', error);
                alert('구역 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 구역 UI 동적 업데이트 (모달 등)
        function updateZoneUI() {
            // 사용자 신청 모달
            const zoneSelection = document.getElementById('zoneSelection');
            if (zoneSelection) {
                zoneSelection.innerHTML = '';
                zones.forEach((zone, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'zone-option';
                    optionDiv.innerHTML = `
                            <input type="radio" id="zone${index}" name="zone" value="${zone.name}">
                            <label for="zone${index}" class="zone-label" data-zone="${zone.name}">
                                ${zone.name}
                                <div class="capacity-info">0/${zone.maxCapacity}</div>
                            </label>
                        `;
                    zoneSelection.appendChild(optionDiv);
                });
            }

            // 관리자 모달
            const adminZoneSelection = document.getElementById('adminZoneSelection');
            if (adminZoneSelection) {
                adminZoneSelection.innerHTML = '';
                zones.forEach((zone, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'zone-option';
                    optionDiv.innerHTML = `
                            <input type="radio" id="admin-zone${index}" name="admin-zone" value="${zone.name}">
                            <label for="admin-zone${index}" class="zone-label" data-zone="${zone.name}">
                                ${zone.name}
                                <div class="capacity-info">0/${zone.maxCapacity}</div>
                            </label>
                        `;
                    adminZoneSelection.appendChild(optionDiv);
                });
            }
            console.log('Zone UI updated');
        }

        // Firestore에서 사용자 목록 로드
        async function loadUsersFromFirestore() {
            // 이미 로드되었으면 다시 로드하지 않음
            if (usersLoaded) {
                console.log('Users already loaded, using cache');
                return;
            }
            
            try {
                console.log('Loading users from Firestore...');
                const { collection, getDocs } = window.firestoreFunctions;
                const usersRef = collection(window.db, 'users');
                const querySnapshot = await getDocs(usersRef);
                allowedUsers = [];
                querySnapshot.forEach((doc) => {
                    allowedUsers.push(doc.data().name);
                });
                usersLoaded = true; // 로드 완료 플래그 설정
                console.log('Loaded users from Firestore:', allowedUsers);
            } catch (error) {
                console.error('사용자 로드 오류:', error);
                alert('사용자 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        function invalidateUsersCache() {
            usersLoaded = false;
            console.log('Users cache invalidated');
        }

        // Firestore에서 데이터 로드
        async function loadDataFromFirestore() {
            try {
                console.log('Loading data from Firestore...');
                const { collection, onSnapshot, query, where } = window.firestoreFunctions;
                const applicantsRef = collection(window.db, 'applicants');
                const currentWeekDates = getCurrentWeekDates();
                const weekQuery = query(
                    applicantsRef,
                    where('actualDate', '>=', currentWeekDates.start),
                    where('actualDate', '<=', currentWeekDates.end)
                );

                onSnapshot(weekQuery, (querySnapshot) => {
                    console.log('Firestore snapshot received:', querySnapshot.size, 'documents');
                    initializeApplicants(); // 초기화

                    allApplications = [];
                    userApplications = [];

                    querySnapshot.forEach((docSnap) => {
                        const data = docSnap.data();
                        const { name, day, zone } = data;
                        if (applicants[day] && applicants[day][zone]) {
                            applicants[day][zone].push(name);
                        }
                        allApplications.push({
                            id: docSnap.id,
                            ...data
                        });
                    });

                    console.log('All applications loaded:', allApplications);
                    filterUserApplications();
                    updateDisplay();
                    if (document.getElementById('cancelModal').style.display === 'block') {
                        updateCancelList();
                    }
                    if (document.getElementById('statsModal').style.display === 'block') {
                        loadMonthlyStats();
                    }
                }, (error) => {
                    console.error('Firestore snapshot error:', error);
                    alert('데이터베이스 연결에 실패했습니다.');
                });
            } catch (error) {
                console.error('Firebase 연결 오류:', error);
                alert('데이터베이스 연결에 실패했습니다.');
            }
        }

        // Firestore에 데이터 저장
        async function saveToFirestore(name, day, zone) {
            try {
                console.log(`Saving to Firestore: ${name}, ${day}, ${zone}`);
                const { collection, addDoc } = window.firestoreFunctions;
                const applicantsRef = collection(window.db, 'applicants');
                const actualDate = getActualDateForDay(day);

                const docRef = await addDoc(applicantsRef, {
                    name: name,
                    day: day,
                    zone: zone,
                    actualDate: actualDate,
                    timestamp: new Date()
                });
                console.log('Document saved with ID:', docRef.id);
                return true;
            } catch (error) {
                console.error('저장 오류:', error);
                alert('신청 저장 중 오류가 발생했습니다.');
                return false;
            }
        }

        // Firestore에서 데이터 삭제
        async function deleteFromFirestore(docId) {
            try {
                console.log('Deleting document with ID:', docId);
                const { deleteDoc, doc } = window.firestoreFunctions;
                await deleteDoc(doc(window.db, 'applicants', docId));
                console.log('Document deleted successfully');
                return true;
            } catch (error) {
                console.error('삭제 오류:', error);
                alert('신청 취소 중 오류가 발생했습니다: ' + error.message);
                return false;
            }
        }

        // Firestore에 사용자 추가
        async function addUserToFirestore(name) {
            try {
                const { collection, addDoc } = window.firestoreFunctions;
                const usersRef = collection(window.db, 'users');
                await addDoc(usersRef, { name: name });
                console.log('User added:', name);
                return true;
            } catch (error) {
                console.error('사용자 추가 오류:', error);
                alert('사용자 추가 중 오류가 발생했습니다.');
                return false;
            }
        }

        // Firestore에서 사용자 삭제
        async function deleteUserFromFirestore(docId) {
            try {
                const { deleteDoc, doc } = window.firestoreFunctions;
                await deleteDoc(doc(window.db, 'users', docId));
                console.log('User deleted with ID:', docId);
                return true;
            } catch (error) {
                console.error('사용자 삭제 오류:', error);
                alert('사용자 삭제 중 오류가 발생했습니다.');
                return false;
            }
        }

        // Firestore에 구역 추가
        async function addZoneToFirestore(name, maxCapacity) {
            try {
                const { collection, addDoc } = window.firestoreFunctions;
                const zonesRef = collection(window.db, 'zones');
                await addDoc(zonesRef, { name: name, maxCapacity: parseInt(maxCapacity) });
                console.log('Zone added:', name);
                return true;
            } catch (error) {
                console.error('구역 추가 오류:', error);
                alert('구역 추가 중 오류가 발생했습니다.');
                return false;
            }
        }

        // Firestore에서 구역 삭제
        async function deleteZoneFromFirestore(docId) {
            try {
                const { deleteDoc, doc } = window.firestoreFunctions;
                await deleteDoc(doc(window.db, 'zones', docId));
                console.log('Zone deleted with ID:', docId);
                return true;
            } catch (error) {
                console.error('구역 삭제 오류:', error);
                alert('구역 삭제 중 오류가 발생했습니다.');
                return false;
            }
        }

        // 로그인 함수
        async function login() {
            const name = document.getElementById('loginName').value.trim();
            if (!name) {
                alert('이름을 입력해주세요.');
                return;
            }

            if (name === 'admin') {
                currentUser = 'admin';
                isAdmin = true;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('adminPage').style.display = 'block';
                console.log('Admin logged in');
                return;
            }

            // 서버에서 사용자 확인
            const { collection, getDocs, query, where } = window.firestoreFunctions;
            const usersRef = collection(window.db, 'users');
            const q = query(usersRef, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert('등록되지 않은 전도인입니다.');
                document.getElementById('loginName').value = '';
                return;
            }

            currentUser = name;
            isAdmin = false;
            document.getElementById('userInfo').textContent = `${currentUser}님 환영합니다!`;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            filterUserApplications();
            updateCancelList();
            updateDisplay();
            console.log('User logged in:', currentUser);
        }

        // 관리자 사용자 선택 목록 채우기
        async function populateAdminUserSelect() {
            const select = document.getElementById('adminUserSelect');
            if (!select) return;
    
            select.innerHTML = '<option value="">사용자를 선택하세요</option>';
    
            // 캐시된 데이터 사용 - DB 호출 최소화
            if (!usersLoaded) {
                await loadUsersFromFirestore();
            }
    
            allowedUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
            console.log('Admin user select populated from cache');
        }

        // 사용자 목록 로드 및 표시 (관리자 페이지 및 모달)
        async function loadAndDisplayUsers() {
            const userManagementListEl = document.getElementById('userManagementList');
            userManagementListEl.innerHTML = '';

            const { collection, getDocs } = window.firestoreFunctions;
            const usersRef = collection(window.db, 'users');
            const querySnapshot = await getDocs(usersRef);

            // 사용자 수 계산
            const userCount = querySnapshot.size;

            // 제목 업데이트
            const userListHeading = document.querySelector('#userManagementModal .user-list h3');
            userListHeading.textContent = `등록된 사용자 (총 ${userCount}명)`;

            if (querySnapshot.empty) {
                userManagementListEl.innerHTML = '<p>등록된 사용자가 없습니다.</p>';
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const userData = docSnap.data();
                const userName = userData.name;
                const docId = docSnap.id;

                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                        <div class="user-name">${userName}</div>
                        <button class="btn danger small" onclick="deleteUser('${docId}', '${userName}')">삭제</button>
                    `;
                userManagementListEl.appendChild(userItem);
            });
        }

        // 새 사용자 추가
        async function addNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            if (!name) {
                alert('이름을 입력해주세요.');
                return;
            }

            // 중복 확인
            const { collection, getDocs, query, where } = window.firestoreFunctions;
            const usersRef = collection(window.db, 'users');
            const q = query(usersRef, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert('이미 등록된 사용자입니다.');
                return;
            }

            const added = await addUserToFirestore(name);
            if (added) {
                alert(`${name}님이 추가되었습니다.`);
                document.getElementById('newUserName').value = '';
                invalidateUsersCache();
                loadUsersFromFirestore();
                populateAdminUserSelect();
                loadAndDisplayUsers();
            }
        }

        // 사용자 삭제
        async function deleteUser(docId, userName) {
            if (confirm(`${userName}님을 삭제하시겠습니까?`)) {
                const deleted = await deleteUserFromFirestore(docId);
                if (deleted) {
                    alert(`${userName}님이 삭제되었습니다.`);
                    invalidateUsersCache();
                    loadUsersFromFirestore();
                    populateAdminUserSelect();
                    loadAndDisplayUsers();
                }
            }
        }

        // 구역 목록 로드 및 표시 (관리자 모달)
        async function loadAndDisplayZones() {
            const zoneManagementListEl = document.getElementById('zoneManagementList');
            zoneManagementListEl.innerHTML = '';

            const { collection, getDocs } = window.firestoreFunctions;
            const zonesRef = collection(window.db, 'zones');
            const querySnapshot = await getDocs(zonesRef);

            if (querySnapshot.empty) {
                zoneManagementListEl.innerHTML = '<p>등록된 구역이 없습니다.</p>';
                return;
            }

            querySnapshot.forEach((docSnap) => {
                const zoneData = docSnap.data();
                const zoneName = zoneData.name;
                const maxCapacity = zoneData.maxCapacity;
                const docId = docSnap.id;

                const zoneItem = document.createElement('div');
                zoneItem.className = 'user-item';
                zoneItem.innerHTML = `
                        <div class="user-name">${zoneName} (용량: ${maxCapacity})</div>
                        <button class="btn danger small" onclick="deleteZone('${docId}', '${zoneName}')">삭제</button>
                    `;
                zoneManagementListEl.appendChild(zoneItem);
            });
        }

        // 새 구역 추가
        async function addNewZone() {
            const name = document.getElementById('newZoneName').value.trim();
            const maxCapacity = document.getElementById('newZoneCapacity').value.trim();
            if (!name || !maxCapacity) {
                alert('구역 이름과 용량을 입력해주세요.');
                return;
            }

            // 중복 확인
            const { collection, getDocs, query, where } = window.firestoreFunctions;
            const zonesRef = collection(window.db, 'zones');
            const q = query(zonesRef, where("name", "==", name));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                alert('이미 등록된 구역입니다.');
                return;
            }

            const added = await addZoneToFirestore(name, maxCapacity);
            if (added) {
                alert(`${name} 구역이 추가되었습니다.`);
                document.getElementById('newZoneName').value = '';
                document.getElementById('newZoneCapacity').value = '4';
                loadZonesFromFirestore();
                loadAndDisplayZones();
            }
        }

        // 구역 삭제
        async function deleteZone(docId, zoneName) {
            if (confirm(`${zoneName} 구역을 삭제하시겠습니까?`)) {
                const deleted = await deleteZoneFromFirestore(docId);
                if (deleted) {
                    alert(`${zoneName} 구역이 삭제되었습니다.`);
                    loadZonesFromFirestore();
                    loadAndDisplayZones();
                }
            }
        }

        // 신청 모달 열기
        function openRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'block';
            setCurrentWeekDates();
            updateZoneDisplayForModal();
            console.log('Registration modal opened');
        }

        // 신청 모달 닫기
        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            document.getElementById('registrationForm').reset();
            document.getElementById('zoneSelectionContainer').classList.remove('show');
            console.log('Registration modal closed');
        }

        // 신청 취소 모달 열기
        function openCancelModal() {
            document.getElementById('cancelModal').style.display = 'block';
            filterUserApplications();
            updateCancelList();
            console.log('Cancel modal opened');
        }

        // 신청 취소 모달 닫기
        function closeCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
            console.log('Cancel modal closed');
        }

        // 사용자 관리 모달 열기
        function openUserManagementModal() {
            document.getElementById('userManagementModal').style.display = 'block';
            loadAndDisplayUsers(); // 모달 열릴 때 사용자 목록 로드
            populateAdminUserSelect(); // 여기서 한 번만 호출
            console.log('User management modal opened');
        }

        // 사용자 관리 모달 닫기
        function closeUserManagementModal() {
            document.getElementById('userManagementModal').style.display = 'none';
            console.log('User management modal closed');
        }

        // 구역 관리 모달 열기
        function openZoneManagementModal() {
            document.getElementById('zoneManagementModal').style.display = 'block';
            loadAndDisplayZones(); // 모달 열릴 때 구역 목록 로드
            console.log('Zone management modal opened');
        }

        // 구역 관리 모달 닫기
        function closeZoneManagementModal() {
            document.getElementById('zoneManagementModal').style.display = 'none';
            console.log('Zone management modal closed');
        }

        // 데이터 통계 모달 열기
        function openStatsModal() {
            document.getElementById('statsModal').style.display = 'block';
            loadMonthlyStats();
            console.log('Stats modal opened');
        }

        // 데이터 통계 모달 닫기
        function closeStatsModal() {
            document.getElementById('statsModal').style.display = 'none';
            console.log('Stats modal closed');
        }

        // 월간 통계 로드
        async function loadMonthlyStats() {
            try {
                console.log('Loading monthly stats for:', currentStatsYear, currentStatsMonth);
                const { collection, getDocs, query, where } = window.firestoreFunctions;
                const applicantsRef = collection(window.db, 'applicants');
                const startDate = new Date(currentStatsYear, currentStatsMonth - 1, 1);
                const endDate = new Date(currentStatsYear, currentStatsMonth, 0);
                const startDateStr = getLocalDateString(startDate);
                const endDateStr = getLocalDateString(endDate);

                const monthQuery = query(
                    applicantsRef,
                    where('actualDate', '>=', startDateStr),
                    where('actualDate', '<=', endDateStr)
                );

                const querySnapshot = await getDocs(monthQuery);
                const monthlyData = [];
                const zoneStats = {};
                const dayStats = {};

                zones.forEach(zone => zoneStats[zone.name] = 0);
                days.forEach(day => dayStats[day] = 0);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    monthlyData.push(data);
                    if (zoneStats[data.zone] !== undefined) {
                        zoneStats[data.zone]++;
                    }
                    if (dayStats[data.day] !== undefined) {
                        dayStats[data.day]++;
                    }
                });

                displayMonthlyStats(monthlyData, zoneStats, dayStats);
            } catch (error) {
                console.error('통계 데이터 로드 오류:', error);
                alert('통계 데이터를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 로컬 날짜 문자열 생성 함수
        function getLocalDateString(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // 월간 통계 화면에 표시
        function displayMonthlyStats(data, zoneStats, dayStats) {
            document.getElementById('currentMonth').textContent = `${currentStatsYear}년 ${currentStatsMonth}월`;

            const summaryEl = document.getElementById('statsSummary');
            const totalApplications = data.length;
            const uniqueUsers = new Set(data.map(d => d.name)).size;

            const zoneCounts = Object.values(zoneStats);
            const mean = totalApplications / zones.length;
            const variance = zoneCounts.reduce((acc, count) => acc + Math.pow(count - mean, 2), 0) / zones.length;
            const stdDev = Math.sqrt(variance);
            const imbalanceRate = mean > 0 ? (stdDev / mean) * 100 : 0;

            summaryEl.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalApplications}</div>
                        <div class="stat-label">총 신청 건수</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${uniqueUsers}</div>
                        <div class="stat-label">참여 인원</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${imbalanceRate.toFixed(1)}%</div>
                        <div class="stat-label">불균형률</div>
                    </div>
                `;

            const zoneStatsEl = document.getElementById('zoneStats');
            const maxZoneCount = Math.max(...Object.values(zoneStats));

            zoneStatsEl.innerHTML = '';
            zones.forEach(zone => {
                const count = zoneStats[zone.name] || 0;
                const percentage = maxZoneCount > 0 ? (count / maxZoneCount) * 100 : 0;
                const zoneCard = document.createElement('div');
                zoneCard.className = 'zone-stat-card';
                zoneCard.innerHTML = `
                        <div class="zone-stat-title">${zone.name}</div>
                        <div class="zone-stat-bar">
                            <div class="zone-stat-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="zone-stat-text">${count}건 신청</div>
                    `;
                zoneStatsEl.appendChild(zoneCard);
            });
            console.log('Monthly stats displayed:', data.length, 'applications');
        }

        // 월 변경
        function changeMonth(direction) {
            currentStatsMonth += direction;
            if (currentStatsMonth > 12) {
                currentStatsMonth = 1;
                currentStatsYear++;
            } else if (currentStatsMonth < 1) {
                currentStatsMonth = 12;
                currentStatsYear--;
            }
            loadMonthlyStats();
            console.log('Month changed to:', currentStatsYear, currentStatsMonth);
        }

        // 현재 주의 날짜 범위 계산
        function getCurrentWeekDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - currentDay);
            const saturday = new Date(sunday);
            saturday.setDate(sunday.getDate() + 6);
            return {
                start: getLocalDateString(sunday),
                end: getLocalDateString(saturday)
            };
        }

        // 특정 요일의 실제 날짜 계산
        function getActualDateForDay(dayName) {
            const today = new Date();
            const currentDay = today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - currentDay);
            const dayMap = {
                '월요일': 1, '화요일': 2, '수요일': 3, '목요일': 4,
                '금요일': 5, '토요일': 6
            };
            const targetDate = new Date(sunday);
            targetDate.setDate(sunday.getDate() + dayMap[dayName]);
            return getLocalDateString(targetDate);
        }

        // 현재 주의 각 요일 날짜 설정
        function setCurrentWeekDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - currentDay);
            const dayElements = [
                { id: 'monday-date', offset: 1 },
                { id: 'tuesday-date', offset: 2 },
                { id: 'wednesday-date', offset: 3 },
                { id: 'thursday-date', offset: 4 },
                { id: 'friday-date', offset: 5 },
                { id: 'saturday-date', offset: 6 }
            ];
            dayElements.forEach(day => {
                const date = new Date(sunday);
                date.setDate(sunday.getDate() + day.offset);
                const dateString = `${date.getMonth() + 1}/${date.getDate()}`;
                const element = document.getElementById(day.id);
                if (element) {
                    element.textContent = dateString;
                }
            });
            console.log('Current week dates set');
        }

        // 관리자 요일 날짜 설정
        function setAdminWeekDates() {
            const today = new Date();
            const currentDay = today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - currentDay);
            const dayElements = [
                { id: 'admin-monday-date', offset: 1 },
                { id: 'admin-tuesday-date', offset: 2 },
                { id: 'admin-wednesday-date', offset: 3 },
                { id: 'admin-thursday-date', offset: 4 },
                { id: 'admin-friday-date', offset: 5 },
                { id: 'admin-saturday-date', offset: 6 }
            ];
            dayElements.forEach(day => {
                const date = new Date(sunday);
                date.setDate(sunday.getDate() + day.offset);
                const dateString = `${date.getMonth() + 1}/${date.getDate()}`;
                const element = document.getElementById(day.id);
                if (element) {
                    element.textContent = dateString;
                }
            });
            console.log('Admin week dates set');
        }

        // 사용자 신청 필터링
        function filterUserApplications() {
            if (!currentUser || isAdmin) {
                userApplications = [];
                return;
            }
            userApplications = allApplications.filter(a => a.name === currentUser);
            console.log('Filtered user applications:', userApplications);
        }

        // 신청 취소 목록 업데이트
        function updateCancelList() {
            const cancelListEl = document.getElementById('cancelList');
            cancelListEl.innerHTML = '';

            if (userApplications.length === 0) {
                const noApplicationsDiv = document.createElement('div');
                noApplicationsDiv.className = 'no-applications';
                noApplicationsDiv.textContent = '신청 내역이 없습니다.';
                cancelListEl.appendChild(noApplicationsDiv);
                console.log('No user applications to display in cancel list');
                return;
            }

            userApplications.forEach(application => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cancel-item';

                const infoDiv = document.createElement('div');
                infoDiv.className = 'cancel-info';

                const dayDiv = document.createElement('div');
                dayDiv.className = 'cancel-day';
                dayDiv.textContent = application.day;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'cancel-details';
                const dateParts = application.actualDate.split('-');
                const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                detailsDiv.textContent = `${dateString} • ${application.zone}`;

                infoDiv.appendChild(dayDiv);
                infoDiv.appendChild(detailsDiv);

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn danger';
                cancelBtn.textContent = '취소';
                cancelBtn.onclick = () => confirmCancelApplication(application);

                itemDiv.appendChild(infoDiv);
                itemDiv.appendChild(cancelBtn);
                cancelListEl.appendChild(itemDiv);
            });
            console.log('User cancel list updated with', userApplications.length, 'items');
        }

        // 신청 취소 확인
        function confirmCancelApplication(application) {
            const dateParts = application.actualDate.split('-');
            const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
            const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            const confirmMessage = `${application.day}(${dateString}) ${application.zone} 전시대 봉사 신청을 취소하시겠습니까?`;

            if (confirm(confirmMessage)) {
                cancelApplication(application.id, application);
            }
        }

        // 신청 취소 실행
        async function cancelApplication(docId, application) {
            const deleted = await deleteFromFirestore(docId);
            if (deleted) {
                const dateParts = application.actualDate.split('-');
                const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                const dateString = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                alert(`${application.day}(${dateString}) ${application.zone} 신청이 취소되었습니다.`);
                closeCancelModal();
            }
        }

        // 모달에서 구역 표시 업데이트
        function updateZoneDisplayForModal() {
            document.querySelectorAll('.zone-label').forEach(label => {
                label.style.background = '';
                label.style.color = '';
                label.style.borderColor = '';
                label.style.cursor = 'pointer';
                label.previousElementSibling.disabled = false;
            });
    
    // 구역 선택 영역으로 부드럽게 스크롤
            const modalContent = document.querySelector('#registrationModal .modal-content');
            const zoneContainer = document.getElementById('zoneSelectionContainer');
    
            if (modalContent && zoneContainer) {
        // 약간의 지연을 두어 DOM 업데이트 완료 후 스크롤
                setTimeout(() => {
                    const containerTop = zoneContainer.offsetTop;
                    const modalScrollTop = modalContent.scrollTop;
                    const modalHeight = modalContent.clientHeight;
                    const containerHeight = zoneContainer.offsetHeight;
            
            // 구역 선택 영역이 모달 중앙에 오도록 계산
                    const targetScrollTop = containerTop - (modalHeight / 2) + (containerHeight / 2);
            
                    modalContent.scrollTo({
                        top: Math.max(0, targetScrollTop),
                        behavior: 'smooth'
                    });
                }, 100);
            }
    
            console.log('Zone display reset for modal and scrolled to zone selection');
        }

        // 특정 요일의 구역 표시 업데이트
        function updateZoneDisplay(selectedDay) {
            const zoneLabels = document.querySelectorAll('#zoneSelection .zone-label');
            zoneLabels.forEach(label => {
                const zoneName = label.dataset.zone;
                const zoneObj = zones.find(z => z.name === zoneName);
                const maxCapacity = zoneObj ? zoneObj.maxCapacity : 4;
                const currentCount = applicants[selectedDay][zoneName].length;
                const capacityInfo = label.querySelector('.capacity-info');
                const radioInput = label.previousElementSibling;

                capacityInfo.textContent = `${currentCount}/${maxCapacity}`;

                if (currentCount >= maxCapacity) {
                    label.style.background = '#ff6b6b';
                    label.style.color = 'white';
                    label.style.borderColor = '#ff6b6b';
                    label.style.cursor = 'not-allowed';
                    radioInput.disabled = true;
                } else {
                    if (!radioInput.checked) {
                        label.style.background = '';
                        label.style.color = '';
                        label.style.borderColor = '';
                    }
                    label.style.cursor = 'pointer';
                    radioInput.disabled = false;
                }
            });
            console.log('Zone display updated for day:', selectedDay);
        }

        // 신청자 목록 업데이트
        function updateDisplay() {
            const applicantsListEl = document.getElementById('applicantsList');
            applicantsListEl.innerHTML = '';

            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-section';

                const dayTitleDiv = document.createElement('div');
                dayTitleDiv.className = 'day-title';
                const dayDate = getDateForDay(day);
                dayTitleDiv.textContent = `${day} (${dayDate})`;
                dayDiv.appendChild(dayTitleDiv);

                zones.forEach(zone => {
                    const zoneApplicants = applicants[day][zone.name] || [];
                    const zoneDiv = document.createElement('div');
                    zoneDiv.className = 'zone-applicants';

                    const zoneNameDiv = document.createElement('div');
                    zoneNameDiv.className = 'zone-name';
                    zoneNameDiv.textContent = `${zone.name} (${zoneApplicants.length}/${zone.maxCapacity})`;

                    const applicantNamesDiv = document.createElement('div');
                    applicantNamesDiv.className = 'applicant-names';
                    applicantNamesDiv.textContent = zoneApplicants.length > 0 ?
                        zoneApplicants.join(', ') : '신청자 없음';

                    zoneDiv.appendChild(zoneNameDiv);
                    zoneDiv.appendChild(applicantNamesDiv);
                    dayDiv.appendChild(zoneDiv);
                });

                applicantsListEl.appendChild(dayDiv);
            });
            console.log('Applicants list updated');
        }

        // 특정 요일의 날짜 가져오기
        function getDateForDay(dayName) {
            const today = new Date();
            const currentDay = today.getDay();
            const sunday = new Date(today);
            sunday.setDate(today.getDate() - currentDay);
            const dayMap = {
                '월요일': 1, '화요일': 2, '수요일': 3, '목요일': 4,
                '금요일': 5, '토요일': 6
            };
            const targetDate = new Date(sunday);
            targetDate.setDate(sunday.getDate() + dayMap[dayName]);
            return `${targetDate.getFullYear()}/${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
        }

        // 요일 선택 시 구역 선택 영역 표시
        document.querySelectorAll('input[name="day"]').forEach(radio => {
            radio.addEventListener('change', function () {
                const zoneContainer = document.getElementById('zoneSelectionContainer');
                if (this.checked) {
                    zoneContainer.classList.add('show');
                    updateZoneDisplay(this.value);
                    document.querySelectorAll('input[name="zone"]').forEach(zoneRadio => {
                        zoneRadio.checked = false;
                    });
                    console.log('Day selected:', this.value);
                }
            });
        });

        // 폼 제출 이벤트 처리
        document.getElementById('registrationForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const selectedDay = document.querySelector('input[name="day"]:checked');
            const selectedZone = document.querySelector('input[name="zone"]:checked');

            if (!selectedDay) {
                alert('요일을 선택해주세요.');
                console.log('Form submission failed: No day selected');
                return;
            }
            if (!selectedZone) {
                alert('구역을 선택해주세요.');
                console.log('Form submission failed: No zone selected');
                return;
            }

            const dayValue = selectedDay.value;
            const zoneValue = selectedZone.value;
            const zoneObj = zones.find(z => z.name === zoneValue);
            const maxCapacity = zoneObj ? zoneObj.maxCapacity : 4;

            if (applicants[dayValue][zoneValue].length >= maxCapacity) {
                alert(`${dayValue} ${zoneValue}은 마감되었습니다.`);
                console.log('Form submission failed: Zone at max capacity');
                return;
            }

            let isDuplicate = false;
            zones.forEach(zone => {
                if (applicants[dayValue][zone.name].includes(currentUser)) {
                    isDuplicate = true;
                }
            });

            if (isDuplicate) {
                alert(`${dayValue}에 이미 신청하셨습니다.`);
                console.log('Form submission failed: Duplicate application');
                return;
            }

            const saved = await saveToFirestore(currentUser, dayValue, zoneValue);
            if (saved) {
                alert(`${dayValue} ${zoneValue} 신청이 완료되었습니다!`);
                closeRegistrationModal();
            }
        });

        // 마감된 구역 클릭 방지
        document.addEventListener('DOMContentLoaded', function() {
    // 기존의 요일 선택 이벤트 리스너를 업데이트
            document.querySelectorAll('input[name="day"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const zoneContainer = document.getElementById('zoneSelectionContainer');
                    if (this.checked) {
                        zoneContainer.classList.add('show');
                        updateZoneDisplay(this.value);
                        document.querySelectorAll('input[name="zone"]').forEach(zoneRadio => {
                            zoneRadio.checked = false;
                        });
                
                // 구역 선택 영역으로 스크롤
                        setTimeout(() => {
                            const modalContent = document.querySelector('#registrationModal .modal-content');
                            if (modalContent && zoneContainer) {
                                const containerTop = zoneContainer.offsetTop;
                                const modalHeight = modalContent.clientHeight;
                                const containerHeight = zoneContainer.offsetHeight;
                        
                        // 구역 선택 영역이 보이도록 스크롤 위치 계산
                                const targetScrollTop = containerTop - 20; // 20px 여백
                        
                                modalContent.scrollTo({
                                    top: Math.max(0, targetScrollTop),
                                    behavior: 'smooth'
                                });
                            }
                        }, 200); // DOM 업데이트 후 스크롤
                
                        console.log('Day selected and scrolled to zones:', this.value);
                    }
                });
            });
        });

        // 모달 외부 클릭 시 닫기
        window.onclick = function (event) {
            const registrationModal = document.getElementById('registrationModal');
            const cancelModal = document.getElementById('cancelModal');
            const adminModal = document.getElementById('adminModal');
            const userManagementModal = document.getElementById('userManagementModal');
            const zoneManagementModal = document.getElementById('zoneManagementModal');
            const statsModal = document.getElementById('statsModal');

            if (event.target === registrationModal) {
                closeRegistrationModal();
            }
            if (event.target === cancelModal) {
                closeCancelModal();
            }
            if (event.target === adminModal) {
                closeAdminModal();
            }
            if (event.target === userManagementModal) {
                closeUserManagementModal();
            }
            if (event.target === zoneManagementModal) {
                closeZoneManagementModal();
            }
            if (event.target === statsModal) {
                closeStatsModal();
            }
        };

        // 관리자 모달 닫기 (임의 배정/취소 모달)
        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        // 관리자 액션 실행 (기존 코드, 필요 시 구현)
        function executeAdminAction() {
            // 구현 필요 (기존 로직)
            alert('관리자 액션 실행 (구현 필요)');
        }

        // 관리자 폼 초기화
        function resetAdminForm() {
            // 구현 필요
            alert('폼 초기화 (구현 필요)');
        }</script>
</body>
</html>
